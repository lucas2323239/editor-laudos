<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Editar Laudo</title>
  <script src="https://cdn.tiny.cloud/1/tdge0xoszz6lmzcrdgcrpng4szzj2xb45mfgzhbs6r35xx5u/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Configura o Supabase
    const supabaseUrl = 'https://txsbhqqnfhxznyokyvfi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4c2JocXFuZmh4em55b2t5dmZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODQ3MTIsImV4cCI6MjA2NzE2MDcxMn0.6R_XIMIpXjwq160eQkHFbmeHDCaYRbebh_SpxU_lWL4';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Função para pegar parâmetro da URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Pega a sigla enviada via URL (ex: ?sigla=GLI)
    const sigla = getQueryParam("sigla");

    // Função para buscar o laudo pelo sigla
    async function carregarLaudo(sigla) {
      if (!sigla) return "<p>Sigla não informada.</p>";
      const { data, error } = await supabase
        .from('laudos')
        .select('conteudo')
        .eq('sigla', sigla)
        .single();

      if (error) {
        console.error(error);
        return `<p>Erro ao carregar laudo: ${error.message}</p>`;
      }

      return data.conteudo || "<p>Laudo vazio.</p>";
    }

    // Inicializa o TinyMCE com conteúdo carregado do Supabase
    (async () => {
      const conteudoInicial = await carregarLaudo(sigla);

      tinymce.init({
        selector: '#editor',
        height: 600,
        menubar: true,
        plugins: 'advlist autolink lists link image charmap print preview anchor ' +
                 'searchreplace visualblocks code fullscreen insertdatetime media table paste code help wordcount lineheight',
        toolbar: 'undo redo | formatselect | fontselect fontsizeselect | ' +
                 'bold italic underline strikethrough forecolor backcolor | ' +
                 'alignleft aligncenter alignright alignjustify | ' +
                 'bullist numlist outdent indent | removeformat | lineheight | code | help',
        font_formats: 'Arial=arial,helvetica,sans-serif;' +
                      'Courier New=courier new,courier,monospace;' +
                      'Georgia=georgia,palatino,serif;' +
                      'Tahoma=tahoma,verdana,sans-serif;' +
                      'Times New Roman=times new roman,times,serif;' +
                      'Verdana=verdana,geneva,sans-serif',
        fontsize_formats: '10px 12px 14px 16px 18px 24px 36px',
        setup: function (editor) {
          // Envia conteúdo atualizado para o FlutterFlow via postMessage
          editor.on('Change KeyUp', function () {
            const conteudo = editor.getContent();
            window.parent.postMessage(conteudo, "*");
          });
        },
        init_instance_callback: function (editor) {
          // Seta o conteúdo vindo do Supabase
          editor.setContent(conteudoInicial);
        },
        content_style: `
          body { font-family: Arial; font-size: 14px; line-height: 1.2; padding: 10px; }
          p { margin: 0 0 8px 0; }
          table { border-collapse: collapse !important; }
          td, th { border: 1px solid #ccc; padding: 5px; }
        `
      });
    })();
  </script>
</head>
<body>
  <textarea id="editor"></textarea>
</body>
</html>

